---
title: "Nonrandom Patterns of Introgressed Regions"
author: "Matt Glasenapp"
date: "2023-10-25"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(sjPlot)
library(fitdistrplus)
library(ggplot2)
library(ggpubr)
library(plyr)
library(dplyr)
library(fitdistrplus)
library(knitr)
```

# R Markdown

## Divergence (dXY) of Introgressed Regions vs. Genome-Wide Background

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Load the csv files containing the distribution of mean dXY values and read as a one-dimensional vector
# Files for posterior probability > 90

introgression_tract_dxy_dist_file_90 = "/Users/matt/Documents/GitHub/dissertation_chapter_2/data/pixy_dxy/introgression_tracts_mean_dxy_dist_90.csv"

species_tree_tract_dxy_dist_file_90 = "/Users/matt/Documents/GitHub/dissertation_chapter_2/data/pixy_dxy/species_tree_tracts_mean_dxy_dist_90.csv"

dist_introgression_tract_dxy_90 <- scan(introgression_tract_dxy_dist_file_90, what = numeric(), sep = ",")
dist_species_tree_tract_dxy_90 <- scan(species_tree_tract_dxy_dist_file_90, what = numeric(), sep = ",")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Files for posterior probability > 80

introgression_tract_dxy_dist_file_80 = "/Users/matt/Documents/GitHub/dissertation_chapter_2/data/pixy_dxy/introgression_tracts_mean_dxy_dist_80.csv"

species_tree_tract_dxy_dist_file_80 = "/Users/matt/Documents/GitHub/dissertation_chapter_2/data/pixy_dxy/species_tree_tracts_mean_dxy_dist_80.csv"

dist_introgression_tract_dxy_80 <- scan(introgression_tract_dxy_dist_file_80, what = numeric(), sep = ",")
dist_species_tree_tract_dxy_80 <- scan(species_tree_tract_dxy_dist_file_80, what = numeric(), sep = ",")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Add one-dimensional vectors of mean dXY values to a dataframe called df
df <- data.frame(
  dist_type = factor(c(rep("introgression_tract", 1000), rep("species_tree_tract", 1000), rep("introgression_tract", 1000), rep("species_tree_tract", 1000))),
  mean_divergence = c(dist_introgression_tract_dxy_90, dist_species_tree_tract_dxy_90, dist_introgression_tract_dxy_80, dist_species_tree_tract_dxy_80),
  posterior_probability = factor(c(rep("probability_90", 2000), rep("probability_80", 2000)))
)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Reorder levels of posterior_probability
df$posterior_probability <- factor(df$posterior_probability, levels = c("probability_90", "probability_80"))
```

``` {r, echo=FALSE, message=FALSE, warning=FALSE}
# Plot histograms of mean absolute nucleotide divergence (dXY)

fig1 <- ggplot(data = df, aes(x = mean_divergence, fill = dist_type)) +
  geom_histogram(aes(y=after_stat(density)), alpha = 0.4, color = "black", binwidth = 0.0001) +
  geom_density(alpha=0) + 
  facet_wrap(
    ~ posterior_probability,
    ncol = 1,
    scales = "free_x",
    labeller = labeller(
      posterior_probability = c(
        "probability_90" = "Posterior Probability Threshold: 90%",
        "probability_80" = "Posterior Probability Threshold: 80%"
      )
    )
  ) +
  scale_fill_manual(values = c("introgression_tract" = "#A6CEE3", "species_tree_tract" = "#FDBF6F")) +
  labs(
    x = "Divergence",
    y = "Frequency",
    fill = "Dist Type"
  ) + theme_blank() +
  theme(
    legend.position = "none",
    panel.grid = element_blank()
  )
```

```{r, echo=FALSE, message=FALSE, fig.cap = "Figure 1. Distribution of mean absolute nucleotide divergence for introgression tracts and species tree tracts by PhyloNet-HMM posterior probability threshold (90%, 80%)"}
plot(fig1)
```

## Shaprio-Wilk tests and QQ Plots
### Introgression Tracts: 90% posterior probability threshold
``` {r, echo=FALSE, message=FALSE, fig.cap = "Figure 2. qqplot for mean dXY distribution for introgression tracts at the 90% threshold"}

introgression_tract_90_shapiro <- shapiro.test(df$mean_divergence[df$dist_type == "introgression_tract" & df$posterior_probability == "probability_90"])

pvalue <- introgression_tract_90_shapiro$p.value

cat("Shapiro-Wilk test p-value = ", round(pvalue, 3), "\n")

introgression_tract_90_qqplot <- ggqqplot(df$mean_divergence[df$dist_type == "introgression_tract" & df$posterior_probability == "probability_90"])

plot(introgression_tract_90_qqplot)
```

### Species Tree Tracts: 90% posterior probability threshold
``` {r, echo=FALSE, message=FALSE, fig.cap = "Figure 3. qqplot for mean dXY distribution for species tree tracts at the 90% threshold"}

species_tree_tract_90_shapiro <- shapiro.test(df$mean_divergence[df$dist_type == "species_tree_tract" & df$posterior_probability == "probability_90"])

pvalue <- species_tree_tract_90_shapiro$p.value

cat("Shapiro-Wilk test p-value = ", round(pvalue, 3), "\n")

species_tree_tract_90_qqplot <- ggqqplot(df$mean_divergence[df$dist_type == "species_tree_tract" & df$posterior_probability == "probability_90"])

plot(species_tree_tract_90_qqplot)
```

### Introgression Tracts: 80% posterior probability threshold
``` {r, echo=FALSE, message=FALSE, fig.cap = "Figure 4. qqplot for mean dXY distribution for introgression tracts at the 80% threshold"}

introgression_tract_80_shapiro <- shapiro.test(df$mean_divergence[df$dist_type == "introgression_tract" & df$posterior_probability == "probability_80"])

pvalue <- introgression_tract_80_shapiro$p.value

cat("Shapiro-Wilk test p-value = ", round(pvalue, 3), "\n")

introgression_tract_80_qqplot <- ggqqplot(df$mean_divergence[df$dist_type == "introgression_tract" & df$posterior_probability == "probability_80"])

plot(introgression_tract_80_qqplot)
```

### Species Tree Tracts: 80% posterior probability threshold
``` {r, echo=FALSE, message=FALSE, fig.cap = "Figure 5. qqplot for mean dXY distribution for species tree tracts at the 80% threshold"}

species_tree_tract_80_shapiro <- shapiro.test(df$mean_divergence[df$dist_type == "species_tree_tract" & df$posterior_probability == "probability_80"])

pvalue <- species_tree_tract_80_shapiro$p.value

cat("Shapiro-Wilk test p-value = ", round(pvalue, 3), "\n")

species_tree_tract_80_qqplot <- ggqqplot(df$mean_divergence[df$dist_type == "species_tree_tract" & df$posterior_probability == "probability_80"])

plot(species_tree_tract_80_qqplot)
```

## Homogeneity of variances 
### F-test to assess homogeneity of variances between Introgression Tract and Species Tree Tract
``` {r, echo=FALSE, message=FALSE, warning=FALSE}
# Perform variance tests
var_test_90 <- var.test(df$mean_divergence[df$dist_type == "introgression_tract" & df$posterior_probability == "probability_90"],
                        df$mean_divergence[df$dist_type == "species_tree_tract" & df$posterior_probability == "probability_90"])

var_test_80 <- var.test(df$mean_divergence[df$dist_type == "introgression_tract" & df$posterior_probability == "probability_80"],
                        df$mean_divergence[df$dist_type == "species_tree_tract" & df$posterior_probability == "probability_80"])

log_var_test_90 <- var.test(log(df$mean_divergence[df$dist_type == "introgression_tract" & df$posterior_probability == "probability_90"]),
                            log(df$mean_divergence[df$dist_type == "species_tree_tract" & df$posterior_probability == "probability_90"]))

log_var_test_80 <- var.test(log(df$mean_divergence[df$dist_type == "introgression_tract" & df$posterior_probability == "probability_80"]),
                            log(df$mean_divergence[df$dist_type == "species_tree_tract" & df$posterior_probability == "probability_80"]))

# Function to format the confidence interval with three digits
format_confidence_interval <- function(conf.int) {
  return(sprintf("[%.3f, %.3f]", conf.int[1], conf.int[2]))
}

# Calculate the ratio of variances
ratio_of_variances <- c(var_test_90$estimate, var_test_80$estimate, log_var_test_90$estimate, log_var_test_80$estimate)

# Create a data frame with test results, including the variance ratio
results <- data.frame(
  "Posterior Probability" = c("90%", "80%", "log(90%)", "log(80%)"),
    "Variance Ratio" = ratio_of_variances,
  "p value" = c(var_test_90$p.value, var_test_80$p.value, log_var_test_90$p.value, log_var_test_80$p.value),
  "Confidence Interval" = sapply(list(var_test_90$conf.int, var_test_80$conf.int, log_var_test_90$conf.int, log_var_test_80$conf.int), format_confidence_interval)
)

# Create a knitr table
kable(results, format = "markdown", digits = 3, align ="c", col.names = c("Posterior Probability", "Variance Ratio", "p", "Confidence Interval"))

```

## Welch Two Sample t-test
``` {r, echo=FALSE, message=FALSE, warning=FALSE}
subset_90 = df[df$posterior_probability == "probability_90", ]
results_90 <- t.test(mean_divergence~dist_type, data=subset_90, paired=FALSE, var.eq=F, alternative="two.sided")

subset_80 = df[df$posterior_probability == "probability_80", ]
results_80 <- t.test(mean_divergence~dist_type, data=subset_80, paired=FALSE, var.eq=T, alternative="two.sided")

# Create a data frame to store the t-test results
t_test_results <- data.frame(
  posterior_probability = c("90%", "80%"),
  t = c(results_90$statistic, results_80$statistic),
  df = c(results_90$parameter, results_80$parameter),
  p_value = c(results_90$p.value, results_80$p.value),
  conf_interval = c(paste0("[", round(results_90$conf.int[1], 4), ", ", round(results_90$conf.int[2], 4), "]"),
                   paste0("[", round(results_80$conf.int[1], 4), ", ", round(results_80$conf.int[2], 4), "]")
  )
)

# Create a kable table
kable(t_test_results, format = "markdown", align = "c", digits = 3, col.names = c("Posterior Probability", "t", "df", "p", "Confidence Interval"))
```

## Figure for manuscript
```{r, echo=FALSE, message=FALSE}
fig2 <- ggplot(data = df, aes(x = mean_divergence, fill = dist_type)) +
  geom_density(aes(y=after_stat(density))) + 
  facet_wrap(
    ~ posterior_probability,
    ncol = 1,
    scales = "free_y",
    #scales = "free_x",
    labeller = labeller(
      posterior_probability = c(
        "probability_90" = "Posterior Probability Threshold: 90%",
        "probability_80" = "Posterior Probability Threshold: 80%"
      )
    )
  ) +
  scale_fill_manual(values = c("introgression_tract" = "#A6CEE3", "species_tree_tract" = "#999999"), labels = c("introgression_tract" = "Introgression Tracts", "species_tree_tract" = "Genome-Wide Background")
) + labs(
  x = expression(
      atop(
        paste("Mean ", italic("H. pulcherrimus"), " - ", italic("S. fragilis")),
        paste("Absolute Nucleotide Divergence (", italic("d")[XY], ")")
      )
    ),
    y = "Probability Density",
    fill = "Dist Type"
  ) + theme_blank() +
  theme(
    axis.title = element_text(size = 16),
    legend.position = "right",
    panel.grid = element_blank(), 
    strip.text = element_text(size = 14),
    legend.text = element_text(size = 12)
  ) + 
  guides(fill = guide_legend(title = NULL))
```

```{r, echo=FALSE, message=FALSE, fig.cap = "Figure 6. Distribution of mean absolute nucleotide divergence for introgression tracts and species tree tracts by PhyloNet-HMM posterior probability threshold (90%, 80%)"}
plot(fig2)
```


```{r, echo=FALSE, message=FALSE}
#setwd("/Users/matt/Documents/GitHub/dissertation_chapter_2/data/pixy_dxy/")
#ggsave(filename = "dXY.eps", plot = fig2)
#ggsave(filename = "dXY.png", plot = fig2)
#ggsave(filename = "dXY.svg", plot = fig2)
```

``` {r, echo=FALSE}
#model1 <- lm(dist_species_tree_tract_dxy_80 ~ 1)
#model2 <- lm(dist_species_tree_tract_dxy_90 ~ 1)

# Calculate the confidence interval
#confint(model1, level=0.95)
#confint(model2, level=0.95)

#mean(dist_introgression_tract_dxy_80)
#mean(dist_introgression_tract_dxy_90)
```
